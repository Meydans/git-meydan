<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mandatory Grocery Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
  </head>
  <body class="bg-slate-950 text-slate-100 min-h-screen">
    <main class="max-w-2xl mx-auto p-4 sm:p-6">
      <header class="mb-6">
        <h1 class="text-2xl sm:text-3xl font-bold">Mandatory Grocery Manager</h1>
        <p class="text-slate-400 mt-1">Check what you already have, then generate and sync your shopping list.</p>
      </header>

      <section class="mb-6 bg-slate-900 border border-slate-800 rounded-xl p-4 sm:p-5">
        <h2 class="text-lg font-semibold mb-3">Apps Menu</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
          <a href="./index.html" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700">Mandatory Grocery Manager</a>
          <a href="./daily-family-planner.html" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700">Daily Family Planner</a>
          <a href="./vaction-planner-2026.html" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700">Vacation Planner 2026</a>
        </div>
      </section>

      <section id="authCard" class="bg-slate-900 border border-slate-800 rounded-xl p-4 sm:p-5">
        <p class="mb-4 text-slate-300">Sign in to load master items from Google Sheets.</p>
        <div class="flex gap-3">
          <button id="signInBtn" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500">Sign in with Google</button>
          <button id="signOutBtn" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 hidden">Sign out</button>
        </div>
        <p id="authStatus" class="mt-3 text-sm text-slate-400"></p>
      </section>

      <section id="appCard" class="hidden mt-6 bg-slate-900 border border-slate-800 rounded-xl p-4 sm:p-5">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Inventory Check</h2>
          <button id="reloadBtn" class="px-3 py-1.5 text-sm rounded-lg bg-slate-700 hover:bg-slate-600">Reload Master</button>
        </div>

        <div class="mb-4 flex flex-col sm:flex-row gap-2">
          <input
            id="newItemInput"
            type="text"
            placeholder="Add grocery item (e.g., milk)"
            class="flex-1 px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500"
          />
          <select
            id="newItemType"
            class="px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500"
          >
            <option value="mandatory">Mandatory</option>
            <option value="optional">Optional</option>
          </select>
          <button id="addItemBtn" class="px-4 py-2 rounded-lg bg-amber-600 hover:bg-amber-500">Add Item</button>
        </div>

        <p class="text-sm text-slate-400 mb-3">Check items you <strong>already have</strong>.</p>
        <div id="masterList" class="space-y-2 max-h-80 overflow-auto pr-1"></div>

        <div class="mt-5 flex flex-wrap gap-3">
          <button id="generateBtn" class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500">Generate List (AI)</button>
          <button id="syncBtn" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            Sync to Sheets
          </button>
        </div>

        <div class="mt-5">
          <h3 class="font-semibold mb-2">Categorized Shopping List</h3>
          <pre id="resultView" class="bg-slate-950 border border-slate-800 rounded-lg p-3 text-sm whitespace-pre-wrap min-h-24"></pre>
        </div>

        <p id="appStatus" class="mt-3 text-sm text-slate-400"></p>
      </section>
    </main>

    <script>
      const CLIENT_ID = "427247172628-tqle335su4809um35beovkdedm26lhf6.apps.googleusercontent.com";
      const SCOPES = "https://www.googleapis.com/auth/spreadsheets";
      const SPREADSHEET_ID = "1EZ3XjCTLHOnt-d3hQpCJ67Mfg0DYwKCN3xEyAgCY_ws";
      const GEMINI_MODEL = "gemini-2.0-flash";

      let tokenClient;
      let accessToken = null;
      let masterItems = [];
      let lastCategorizedRows = [];
      let sourceDirty = false;

      const appCard = document.getElementById("appCard");
      const signInBtn = document.getElementById("signInBtn");
      const signOutBtn = document.getElementById("signOutBtn");
      const reloadBtn = document.getElementById("reloadBtn");
      const newItemInput = document.getElementById("newItemInput");
      const newItemType = document.getElementById("newItemType");
      const addItemBtn = document.getElementById("addItemBtn");
      const generateBtn = document.getElementById("generateBtn");
      const syncBtn = document.getElementById("syncBtn");
      const masterList = document.getElementById("masterList");
      const resultView = document.getElementById("resultView");
      const authStatus = document.getElementById("authStatus");
      const appStatus = document.getElementById("appStatus");

      function setAuthStatus(msg) {
        authStatus.textContent = msg;
      }

      function setAppStatus(msg) {
        appStatus.textContent = msg;
      }

      function normalizeType(rawType) {
        return String(rawType || "").trim().toLowerCase() === "mandatory" ? "mandatory" : "optional";
      }

      function itemKey(name, type) {
        return `${name.toLowerCase()}::${type}`;
      }

      function updateSyncButton() {
        syncBtn.disabled = !(sourceDirty || lastCategorizedRows.length > 0);
      }

      window.onload = () => {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: async (resp) => {
            if (resp.error) {
              setAuthStatus(`Sign-in failed: ${resp.error}`);
              return;
            }
            accessToken = resp.access_token;
            signInBtn.classList.add("hidden");
            signOutBtn.classList.remove("hidden");
            appCard.classList.remove("hidden");
            setAuthStatus("Signed in.");
            await loadMasterItems();
          }
        });

        signInBtn.addEventListener("click", () => tokenClient.requestAccessToken({ prompt: "consent" }));
        signOutBtn.addEventListener("click", signOut);
        reloadBtn.addEventListener("click", loadMasterItems);
        addItemBtn.addEventListener("click", addItem);
        newItemInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") addItem();
        });
        generateBtn.addEventListener("click", generateListWithGemini);
        syncBtn.addEventListener("click", syncSheets);

      };

      function signOut() {
        if (accessToken) google.accounts.oauth2.revoke(accessToken, () => {});
        accessToken = null;
        masterItems = [];
        lastCategorizedRows = [];
        sourceDirty = false;
        masterList.innerHTML = "";
        resultView.textContent = "";
        updateSyncButton();
        appCard.classList.add("hidden");
        signInBtn.classList.remove("hidden");
        signOutBtn.classList.add("hidden");
        setAuthStatus("Signed out.");
        setAppStatus("");
      }

      async function sheetsFetch(path, options = {}) {
        if (!accessToken) throw new Error("Not authenticated.");
        const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/${path}`, {
          ...options,
          headers: {
            Authorization: `Bearer ${accessToken}`,
            "Content-Type": "application/json",
            ...(options.headers || {})
          }
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error?.message || "Sheets API error.");
        return data;
      }

      async function loadMasterItems() {
        try {
          setAppStatus("Loading master items...");
          const existing = new Map(masterItems.map((item) => [itemKey(item.name, item.type), item.has]));
          const data = await sheetsFetch("values/Master!A2:B");
          const rows = data.values || [];
          const nextItems = [];

          rows.forEach((row, idx) => {
            const name = String(row[0] || "").trim();
            if (!name) return;
            const type = normalizeType(row[1]);
            const key = itemKey(name, type);
            nextItems.push({
              id: `${name.toLowerCase().replace(/\s+/g, "-")}-${idx}`,
              name,
              type,
              has: existing.get(key) || false
            });
          });

          masterItems = nextItems;
          sourceDirty = false;
          renderMasterList();

          const mandatoryCount = masterItems.filter((item) => item.type === "mandatory").length;
          const optionalCount = masterItems.length - mandatoryCount;
          setAppStatus(`Loaded ${masterItems.length} master item(s) (${mandatoryCount} mandatory, ${optionalCount} optional).`);
          updateSyncButton();
        } catch (err) {
          setAppStatus(`Load failed: ${err.message}`);
        }
      }

      function renderMasterList() {
        if (!masterItems.length) {
          masterList.innerHTML = '<p class="text-slate-400 text-sm">No items found in Master!A2:B</p>';
          return;
        }

        masterList.innerHTML = masterItems
          .map(
            (item, idx) => `
          <label class="flex items-center gap-3 p-2 rounded-lg bg-slate-800/60">
            <input type="checkbox" data-idx="${idx}" ${item.has ? "checked" : ""} class="h-4 w-4 accent-emerald-500" />
            <span class="flex-1">${escapeHtml(item.name)}</span>
            ${
              item.type === "mandatory"
                ? '<span class="text-xs px-2 py-1 rounded-full bg-rose-900/50 border border-rose-700 text-rose-200">â˜… Mandatory</span>'
                : '<span class="text-xs px-2 py-1 rounded-full bg-slate-700 border border-slate-600 text-slate-200">Optional</span>'
            }
          </label>
        `
          )
          .join("");

        masterList.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
          checkbox.addEventListener("change", (e) => {
            const idx = Number(e.target.dataset.idx);
            if (Number.isInteger(idx) && masterItems[idx]) {
              masterItems[idx].has = e.target.checked;
            }
          });
        });
      }

      function addItem() {
        const name = newItemInput.value.trim();
        const type = normalizeType(newItemType.value);

        if (!name) {
          setAppStatus("Enter an item name first.");
          return;
        }

        const exists = masterItems.some((item) => item.name.toLowerCase() === name.toLowerCase());
        if (exists) {
          setAppStatus("That item already exists in Master.");
          return;
        }

        masterItems.push({
          id: `${name.toLowerCase().replace(/\s+/g, "-")}-${Date.now()}`,
          name,
          type,
          has: false
        });

        sourceDirty = true;
        newItemInput.value = "";
        renderMasterList();
        updateSyncButton();
        setAppStatus(`Added "${name}" as ${type}. Click Sync to save to Master.`);
      }

      function getMissingItems() {
        return masterItems.filter((item) => !item.has);
      }

      async function generateListWithGemini() {
        try {
          const missing = getMissingItems();
          if (!missing.length) {
            resultView.textContent = "Nothing missing. You already have everything.";
            lastCategorizedRows = [];
            updateSyncButton();
            setAppStatus("No missing items.");
            return;
          }

          setAppStatus("Generating categorized list with Gemini...");
          const prompt = `
You are a grocery assistant.
Task:
1) Take the missing grocery items below, including their type (mandatory or optional).
2) Group them by supermarket aisle (example categories: Produce, Dairy, Meat, Seafood, Frozen, Bakery, Pantry, Beverages, Household, Personal Care, Other).
3) Return ONLY valid JSON in this exact format:
{
  "categories": [
    { "name": "Produce", "items": ["apples", "lettuce"] }
  ]
}
Missing items:
${JSON.stringify(missing.map((item) => ({ item: item.name, type: item.type })))}
          `.trim();

          const res = await fetch("/api/gemini", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              model: GEMINI_MODEL,
              prompt
            })
          });

          const data = await res.json();
          if (!res.ok) throw new Error(data.error?.message || "Gemini API error.");

          const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";
          const parsed = parseGeminiJson(text);

          const rows = [];
          let pretty = "";
          for (const cat of parsed.categories || []) {
            const name = String(cat.name || "Other").trim();
            const items = Array.isArray(cat.items) ? cat.items.map((v) => String(v).trim()).filter(Boolean) : [];
            if (!items.length) continue;
            pretty += `${name}\n`;
            for (const item of items) {
              pretty += `  - ${item}\n`;
              rows.push([name, item]);
            }
            pretty += "\n";
          }

          if (!rows.length) throw new Error("Gemini returned no usable items.");

          lastCategorizedRows = rows;
          resultView.textContent = pretty.trim();
          updateSyncButton();
          setAppStatus("Generated. Click Sync to update Master and Current sheets.");
        } catch (err) {
          setAppStatus(`Generate failed: ${err.message}`);
        }
      }

      function parseGeminiJson(text) {
        const cleaned = text.replace(/^```json\s*/i, "").replace(/^```\s*/i, "").replace(/```$/i, "").trim();
        return JSON.parse(cleaned);
      }

      async function syncSheets() {
        try {
          setAppStatus("Syncing Master and Current sheets...");

          await sheetsFetch("values/Master!A:B:clear", { method: "POST", body: JSON.stringify({}) });
          const masterValues = [["Item", "Type"], ...masterItems.map((item) => [item.name, item.type])];
          await sheetsFetch("values/Master!A1?valueInputOption=RAW", {
            method: "PUT",
            body: JSON.stringify({ values: masterValues })
          });

          try {
            await sheetsFetch("values/Current!A:B:clear", { method: "POST", body: JSON.stringify({}) });
            const currentValues = [["Category", "Item"], ...lastCategorizedRows];
            await sheetsFetch("values/Current!A1?valueInputOption=RAW", {
              method: "PUT",
              body: JSON.stringify({ values: currentValues })
            });
          } catch (currentErr) {
            sourceDirty = false;
            updateSyncButton();
            setAppStatus(`Master synced, but Current failed: ${currentErr.message}`);
            return;
          }

          sourceDirty = false;
          updateSyncButton();
          setAppStatus(`Synced Master (${masterItems.length} items) and Current (${lastCategorizedRows.length} rows).`);
        } catch (err) {
          setAppStatus(`Sync failed before Current update: ${err.message}`);
        }
      }

      function escapeHtml(str) {
        return str
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }
    </script>
  </body>
</html>
